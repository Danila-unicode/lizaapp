<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .user-section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –æ–±–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞–º–∏</h1>
        
        <div class="user-section">
            <h2>User 1</h2>
            <input type="text" id="user1Id" value="user1" placeholder="User ID">
            <button onclick="startUser1()">–ó–∞–ø—É—Å—Ç–∏—Ç—å User 1</button>
            <button onclick="sendPing1()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user2</button>
            <button onclick="resetUser1()" style="background: #ff9800; color: white;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            <div id="log1" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>User 2</h2>
            <input type="text" id="user2Id" value="user2" placeholder="User ID">
            <button onclick="startUser2()">–ó–∞–ø—É—Å—Ç–∏—Ç—å User 2</button>
            <button onclick="sendPing2()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user1</button>
            <button onclick="resetUser2()" style="background: #ff9800; color: white;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            <div id="log2" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤</h2>
            <button onclick="copyAllLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        const SIGNALING_SERVER = 'https://functions.yandexcloud.net/d4ec0rusp5blvc9pucd4';
        
        let user1 = {
            id: 'user1',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected
            targetUser: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log1');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        let user2 = {
            id: 'user2',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected
            targetUser: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log2');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        function startUser1() {
            user1.id = document.getElementById('user1Id').value;
            user1.lastSignalId = Math.floor(Date.now() / 1000);
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`üöÄ –ó–∞–ø—É—Å–∫ User 1: ${user1.id}`, 'success');
            user1.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${user1.lastSignalId}`, 'info');
            user1.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${user1.state}`, 'info');
            
            if (user1.interval) clearInterval(user1.interval);
            user1.interval = setInterval(() => checkSignals(user1), 2000);
            checkSignals(user1);
        }
        
        function startUser2() {
            user2.id = document.getElementById('user2Id').value;
            user2.lastSignalId = Math.floor(Date.now() / 1000);
            user2.state = 'idle';
            user2.targetUser = null;
            user2.log(`üöÄ –ó–∞–ø—É—Å–∫ User 2: ${user2.id}`, 'success');
            user2.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${user2.lastSignalId}`, 'info');
            user2.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'info');
            
            if (user2.interval) clearInterval(user2.interval);
            user2.interval = setInterval(() => checkSignals(user2), 2000);
            checkSignals(user2);
        }
        
        async function sendPing1() {
            if (user1.state !== 'idle') {
                user1.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user1.state}`, 'warning');
                return;
            }
            user1.state = 'connecting';
            user1.targetUser = user2.id;
            user1.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user1.state}`, 'info');
            await sendSignal(user1, user2.id, 'ping', { test: true });
        }
        
        async function sendPing2() {
            if (user2.state !== 'idle') {
                user2.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'warning');
                return;
            }
            user2.state = 'connecting';
            user2.targetUser = user1.id;
            user2.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user2.state}`, 'info');
            await sendSignal(user2, user1.id, 'ping', { test: true });
        }
        
        async function sendSignal(user, to, type, data) {
            try {
                user.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${type} –∫ ${to}`, 'warning');
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: to,
                        type: type,
                        data: data
                    })
                });
                
                const result = await response.json();
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    user.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error}`, 'error');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function checkSignals(user) {
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${user.id}&since=${user.lastSignalId}`;
                user.log(`üîç –ó–∞–ø—Ä–æ—Å: ${url}`, 'info');
                
                const response = await fetch(url);
                const data = await response.json();
                
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.signals && data.signals.length > 0) {
                    user.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–∏–≥–Ω–∞–ª—ã (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        const isNew = signalTimestamp > user.lastSignalId;
                        if (!isNew) {
                            user.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} (timestamp: ${signalTimestamp} <= ${user.lastSignalId})`, 'warning');
                        }
                        return isNew;
                    });
                    
                    if (newSignals.length === 0) {
                        user.log(`üîç –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—ã–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º`, 'info');
                        // –û–±–Ω–æ–≤–ª—è–µ–º lastSignalId –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                        const maxTimestamp = Math.max(...data.signals.map(s => s.timestamp || s.id));
                        user.lastSignalId = Math.max(user.lastSignalId, maxTimestamp);
                        return;
                    }
                    
                    user.log(`üì® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${newSignals.length} –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    newSignals.forEach(signal => {
                        user.lastSignalId = Math.max(user.lastSignalId, signal.timestamp || signal.id);
                        user.log(`üì® ${signal.type} –æ—Ç ${signal.from}`, 'success');
                        
                        if (signal.type === 'ping') {
                            if (user.state === 'idle') {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'warning');
                                user.state = 'connecting';
                                user.targetUser = signal.from;
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                                sendSignal(user, signal.from, 'pong', { received: true });
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                            }
                        } else if (signal.type === 'pong') {
                            if (user.state === 'connecting' && user.targetUser === signal.from) {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                                user.state = 'connected';
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'success');
                                user.log(`üîó P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è WebRTC!`, 'success');
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}, –æ–∂–∏–¥–∞–ª–∏: ${user.targetUser}`, 'warning');
                            }
                        }
                    });
                } else {
                    user.log(`üîç –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
            }
        }
        
        function copyAllLogs() {
            try {
                const log1 = document.getElementById('log1').innerText;
                const log2 = document.getElementById('log2').innerText;
                
                const allLogs = `=== –õ–û–ì–ò USER 1 ===\n${log1}\n\n=== –õ–û–ì–ò USER 2 ===\n${log2}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${SIGNALING_SERVER}\nUser 1 ID: ${user1.id}\nUser 2 ID: ${user2.id}`;
                
                // –ü—Ä–æ–±—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(allLogs).then(() => {
                        showCopySuccess();
                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ clipboard API: ', err);
                        fallbackCopy(allLogs);
                    });
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    fallbackCopy(allLogs);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ copyAllLogs: ', error);
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            }
        }
        
        function fallbackCopy(text) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π textarea
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function resetUser1() {
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ: ${user1.state}`, 'warning');
        }
        
        function resetUser2() {
            user2.state = 'idle';
            user2.targetUser = null;
            user2.log(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ: ${user2.state}`, 'warning');
        }
        
        function showCopySuccess() {
            const button = document.querySelector('button[onclick="copyAllLogs()"]');
            const originalText = button.textContent;
            button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            button.style.background = '#45a049';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#4CAF50';
            }, 2000);
            
            console.log('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        }
    </script>
</body>
</html>
