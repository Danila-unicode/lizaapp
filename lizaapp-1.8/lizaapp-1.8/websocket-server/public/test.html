<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Signaling Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .user-section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Signaling Test</h1>
        
        <div class="user-section">
            <h2>User 1</h2>
            <button onclick="connectUser1()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å User 1</button>
            <button onclick="sendPing1()" id="pingBtn1" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user2</button>
            <button onclick="sendOffer1()" id="offerBtn1" disabled style="display: none;">üì§ –¢–µ—Å—Ç Offer</button>
            <button onclick="disconnectUser1()" id="disconnectBtn1" disabled style="display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            <div id="log1" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>User 2</h2>
            <button onclick="connectUser2()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å User 2</button>
            <button onclick="sendPing2()" id="pingBtn2" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user1</button>
            <div id="autoAnswerInfo" style="display: none; color: #4CAF50; font-weight: bold;">ü§ñ Answer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ offer</div>
            <div id="log2" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h2>
            <button onclick="getStats()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <div id="stats" class="log"></div>
        </div>
    </div>

    <script>
        let user1 = {
            ws: null,
            userId: null,
            state: 'idle',
            targetUser: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log1');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        let user2 = {
            ws: null,
            userId: null,
            state: 'idle',
            targetUser: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log2');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        function connectUser1() {
            if (user1.ws) {
                user1.log('User 1 —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'warning');
                return;
            }
            
            user1.ws = new WebSocket('ws://localhost:8080');
            
            user1.ws.onopen = () => {
                user1.log('User 1 –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É', 'success');
                document.getElementById('pingBtn1').disabled = false;
            };
            
            user1.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(user1, message);
            };
            
            user1.ws.onclose = () => {
                user1.log('User 1 –æ—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
                user1.ws = null;
                user1.state = 'idle';
                user1.targetUser = null;
                updateButtons(user1);
            };
            
            user1.ws.onerror = (error) => {
                user1.log(`–û—à–∏–±–∫–∞ WebSocket: ${error.message}`, 'error');
            };
        }
        
        function connectUser2() {
            if (user2.ws) {
                user2.log('User 2 —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'warning');
                return;
            }
            
            user2.ws = new WebSocket('ws://localhost:8080');
            
            user2.ws.onopen = () => {
                user2.log('User 2 –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É', 'success');
                document.getElementById('pingBtn2').disabled = false;
            };
            
            user2.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(user2, message);
            };
            
            user2.ws.onclose = () => {
                user2.log('User 2 –æ—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
                user2.ws = null;
                user2.state = 'idle';
                user2.targetUser = null;
                updateButtons(user2);
            };
            
            user2.ws.onerror = (error) => {
                user2.log(`–û—à–∏–±–∫–∞ WebSocket: ${error.message}`, 'error');
            };
        }
        
        function handleMessage(user, message) {
            switch (message.type) {
                case 'connected':
                    user.userId = message.userId;
                    user.log(`–ü–æ–ª—É—á–µ–Ω ID: ${message.userId}`, 'success');
                    break;
                    
                case 'ping':
                    user.log(`–ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${message.from}`, 'warning');
                    if (user.state === 'idle') {
                        user.state = 'connecting';
                        user.targetUser = message.from;
                        user.log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                        sendPong(user, message.from);
                    }
                    break;
                    
                case 'pong':
                    user.log(`–ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${message.from}`, 'success');
                    if (user.state === 'connecting') {
                        user.state = 'connected';
                        user.targetUser = message.from;
                        user.log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å ${message.from}`, 'success');
                        updateButtons(user);
                    }
                    break;
                    
                case 'offer':
                    user.log(`–ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${message.from}`, 'warning');
                    if (user.state === 'connected') {
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                        sendAnswer(user, message.from);
                    }
                    break;
                    
                case 'answer':
                    user.log(`–ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${message.from}`, 'success');
                    user.log(`Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!`, 'success');
                    break;
                    
                case 'disconnect':
                    user.log(`–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª disconnect –æ—Ç ${message.from}`, 'warning');
                    user.state = 'idle';
                    user.targetUser = null;
                    user.log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`, 'success');
                    updateButtons(user);
                    break;
                    
                default:
                    user.log(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: ${message.type}`, 'warning');
            }
        }
        
        function sendPing1() {
            if (!user1.ws || user1.state !== 'idle') {
                user1.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping', 'warning');
                return;
            }
            
            user1.state = 'connecting';
            user1.targetUser = 'user2';
            user1.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ user2`, 'warning');
            
            user1.ws.send(JSON.stringify({
                type: 'ping',
                to: 'user2',
                data: { test: true }
            }));
        }
        
        function sendPing2() {
            if (!user2.ws || user2.state !== 'idle') {
                user2.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping', 'warning');
                return;
            }
            
            user2.state = 'connecting';
            user2.targetUser = 'user1';
            user2.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ user1`, 'warning');
            
            user2.ws.send(JSON.stringify({
                type: 'ping',
                to: 'user1',
                data: { test: true }
            }));
        }
        
        function sendPong(user, toUserId) {
            user.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ pong –∫ ${toUserId}`, 'warning');
            user.state = 'connected';
            user.targetUser = toUserId;
            
            user.ws.send(JSON.stringify({
                type: 'pong',
                to: toUserId,
                data: { received: true }
            }));
            
            updateButtons(user);
        }
        
        function sendOffer1() {
            if (!user1.ws || user1.state !== 'connected') {
                user1.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å offer', 'warning');
                return;
            }
            
            user1.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ offer –∫ user2`, 'warning');
            
            const testOffer = {
                type: 'offer',
                sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:test\r\na=ice-pwd:test\r\na=fingerprint:sha-256 test\r\na=setup:actpass\r\na=mid:0\r\na=sendrecv\r\na=rtpmap:111 opus/48000/2\r\n'
            };
            
            user1.ws.send(JSON.stringify({
                type: 'offer',
                to: 'user2',
                data: testOffer
            }));
        }
        
        function sendAnswer(user, toUserId) {
            user.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ answer –∫ ${toUserId}`, 'warning');
            
            const testAnswer = {
                type: 'answer',
                sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:test\r\na=ice-pwd:test\r\na=fingerprint:sha-256 test\r\na=setup:active\r\na=mid:0\r\na=sendrecv\r\na=rtpmap:111 opus/48000/2\r\n'
            };
            
            user.ws.send(JSON.stringify({
                type: 'answer',
                to: toUserId,
                data: testAnswer
            }));
        }
        
        function disconnectUser1() {
            if (!user1.ws || user1.state !== 'connected') {
                user1.log('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞', 'warning');
                return;
            }
            
            user1.log(`–†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${user1.targetUser}`, 'warning');
            
            user1.ws.send(JSON.stringify({
                type: 'disconnect',
                to: user1.targetUser,
                data: { reason: 'user_disconnect' }
            }));
            
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`, 'success');
            updateButtons(user1);
        }
        
        function updateButtons(user) {
            if (user === user1) {
                const offerBtn = document.getElementById('offerBtn1');
                const disconnectBtn = document.getElementById('disconnectBtn1');
                
                if (user.state === 'connected') {
                    offerBtn.style.display = 'inline-block';
                    offerBtn.disabled = false;
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                } else {
                    offerBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                }
            } else if (user === user2) {
                const autoAnswerInfo = document.getElementById('autoAnswerInfo');
                if (user.state === 'connected') {
                    autoAnswerInfo.style.display = 'block';
                } else {
                    autoAnswerInfo.style.display = 'none';
                }
            }
        }
        
        function getStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const statsEl = document.getElementById('stats');
                    statsEl.innerHTML = `<div class="info">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.connectedUsers}</div>`;
                    data.users.forEach(user => {
                        statsEl.innerHTML += `<div class="info">- ${user.id}: ${user.state} (${user.targetUser || '–Ω–µ—Ç —Ü–µ–ª–∏'})</div>`;
                    });
                })
                .catch(error => {
                    document.getElementById('stats').innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}</div>`;
                });
        }
    </script>
</body>
</html>
