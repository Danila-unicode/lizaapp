<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ - LizaApp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 8px; background: #fafafa; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ LizaApp</h1>
        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ª–æ–≥–∏–Ω–æ–º –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
        <button onclick="window.open('https://lizaapp.wg01.ru/register.php', '_blank')" style="background: #4CAF50; color: white; padding: 10px 20px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        
        <div class="user-section">
            <h2>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="loginSection">
                <input type="text" id="userId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
                <input type="password" id="userPassword" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display: none;">
                <button onclick="showPasswordField()">–í–æ–π—Ç–∏</button>
        </div>
            
            <div id="userInfo" style="display: none;">
                <div id="userStatus" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω</div>
                <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="currentUserId"></span></p>
                <input type="text" id="targetUserId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                <button onclick="startCall()" id="startCallBtn" disabled style="background: #4CAF50; color: white; display: none;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <button onclick="disconnectCall()" id="disconnectBtn" disabled style="background: #f44336; color: white; display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                <button onclick="resetUser()" style="background: #ff9800; color: white; display: none;">üîÑ –í—ã–π—Ç–∏</button>
        </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000; border-radius: 5px;"></video>
                <video id="remoteVideo" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000; border-radius: 5px;"></video>
            </div>
            
            <div id="log" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>üìã –õ–æ–≥–∏</h2>
            <button onclick="copyLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        console.log('Script started');
        const SIGNALING_SERVER = 'https://89.169.141.202:3000/api/signaling';
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:89.169.141.202:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                { 
                    urls: 'turns:62.84.126.200:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = {
            id: null,
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            sessionToken: null,
            isInitiator: false,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
        function showPasswordField() {
            const passwordField = document.getElementById('userPassword');
            const loginButton = event.target;
            
            if (passwordField.style.display === 'none') {
                passwordField.style.display = 'block';
                loginButton.textContent = '–í–æ–π—Ç–∏';
                loginButton.onclick = () => startUser();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function startUser() {
            const username = document.getElementById('userId').value;
            const password = document.getElementById('userPassword').value;
            
            if (!username) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω`, 'error');
                return;
            }
            
            if (!password) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å`, 'error');
                return;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUser.log(`üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}...`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser.id = username;
                    currentUser.sessionToken = data.sessionToken;
                    currentUser.log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}`, 'error');
                    return;
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º`, 'error');
                return;
            }
            
            currentUser.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.id} –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º`, 'success');
            currentUser.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${currentUser.lastSignalId}`, 'info');
            currentUser.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log('‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
                if (currentUser.interval) clearInterval(currentUser.interval);
                currentUser.interval = setInterval(() => checkSignals(), 3000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                checkSignals();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI();
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        function updateUI() {
            const loginSection = document.getElementById('loginSection');
            const userInfo = document.getElementById('userInfo');
            const userStatus = document.getElementById('userStatus');
            const currentUserId = document.getElementById('currentUserId');
            const startCallBtn = document.getElementById('startCallBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const resetBtn = document.querySelector('button[onclick="resetUser()"]');
            
            if (currentUser.id) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'none';
                userInfo.style.display = 'block';
                currentUserId.textContent = currentUser.id;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                userStatus.textContent = getStatusText();
                userStatus.className = `status ${currentUser.state}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                if (currentUser.state === 'idle') {
                    startCallBtn.style.display = 'inline-block';
                    startCallBtn.disabled = false;
                    disconnectBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                } else if (currentUser.state === 'connecting' || currentUser.state === 'connected' || currentUser.state === 'calling') {
                    startCallBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                    resetBtn.style.display = 'inline-block';
                }
                } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        function getStatusText() {
            switch (currentUser.state) {
                case 'idle': return '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º';
                case 'connecting': return '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                case 'connected': return '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                case 'calling': return '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                default: return '–û—Ç–∫–ª—é—á–µ–Ω';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞
        async function startCall() {
            const targetId = document.getElementById('targetUserId').value;
            
            if (!targetId) {
                currentUser.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'error');
                return;
            }
            
            currentUser.log(`üìû –ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫ –∫ ${targetId}`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = targetId;
            currentUser.isInitiator = true;
            updateUI();
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping
                const pingData = {
                    action: 'ping',
                    from: currentUser.id,
                    to: targetId,
                    data: { timestamp: Date.now() }
                };
                
                currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pingData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser.log(`‚úÖ Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    // –ñ–¥–µ–º pong
                    setTimeout(() => checkSignals(), 100);
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${result.message}`, 'error');
                    currentUser.state = 'idle';
                    currentUser.targetUser = null;
                    currentUser.isInitiator = false;
                    updateUI();
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${error.message}`, 'error');
                currentUser.state = 'idle';
                currentUser.targetUser = null;
                currentUser.isInitiator = false;
                updateUI();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
        async function checkSignals() {
            if (currentUser.checkingSignals) {
                return;
            }
            currentUser.checkingSignals = true;
            
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${currentUser.id}&since=${currentUser.lastSignalId}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.signals && data.signals.length > 0) {
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        return signalTimestamp > currentUser.lastSignalId;
                    });
                    
                    if (newSignals.length > 0) {
                        for (const signal of newSignals) {
                            currentUser.lastSignalId = Math.max(currentUser.lastSignalId, signal.timestamp || signal.id);
                            currentUser.log(`üì® –ü–æ–ª—É—á–µ–Ω ${signal.type} –æ—Ç ${signal.from}`, 'info');
                            
                            if (signal.type === 'ping') {
                                handlePing(signal);
                            } else if (signal.type === 'pong') {
                                handlePong(signal);
                            } else if (signal.type === 'offer') {
                                handleOffer(signal);
                            } else if (signal.type === 'answer') {
                                handleAnswer(signal);
                            } else if (signal.type === 'ice-candidate') {
                                handleIceCandidate(signal);
                            } else if (signal.type === 'disconnect') {
                                handleDisconnect(signal);
                            }
                        }
                        
                        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                        await deleteProcessedSignals();
                    }
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            } finally {
                currentUser.checkingSignals = false;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ping
        async function handlePing(signal) {
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = signal.from;
            currentUser.isInitiator = false;
            updateUI();
            
            try {
                const pongData = {
                    action: 'signal',
                    from: currentUser.id,
                    to: signal.from,
                    type: 'pong',
                    data: { received: true }
                };
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pongData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser.log(`‚úÖ Pong –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    currentUser.state = 'connected';
                    updateUI();
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong: ${result.message}`, 'error');
                }
                                } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ pong
        function handlePong(signal) {
            if (currentUser.state === 'connecting' && currentUser.targetUser === signal.from) {
                currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                currentUser.state = 'connected';
                updateUI();
                            } else {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ offer
        async function handleOffer(signal) {
            if (currentUser.state !== 'connected') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => {
                        currentUser.peerConnection.addTrack(track, currentUser.localStream);
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await currentUser.peerConnection.setRemoteDescription(signal.data);
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                const answer = await currentUser.peerConnection.createAnswer();
                await currentUser.peerConnection.setLocalDescription(answer);
                
                await sendSignal('answer', answer);
                currentUser.log('‚úÖ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(signal) {
            if (currentUser.state !== 'connecting') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }

            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'info');
            
            try {
                if (currentUser.peerConnection) {
                    await currentUser.peerConnection.setRemoteDescription(signal.data);
                    currentUser.log('‚úÖ Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                    currentUser.state = 'calling';
                    updateUI();
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        async function handleIceCandidate(signal) {
            if (currentUser.peerConnection) {
                try {
                    await currentUser.peerConnection.addIceCandidate(signal.data);
                    currentUser.log(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${signal.from}`, 'info');
            } catch (error) {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ disconnect
        function handleDisconnect(signal) {
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω disconnect –æ—Ç ${signal.from}`, 'warning');
            
            if (currentUser.targetUser === signal.from) {
                currentUser.log(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ`, 'warning');
                resetUser();
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
        async function sendSignal(type, data) {
            try {
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: currentUser.id,
                        to: currentUser.targetUser,
                        type: type,
                        data: data
                    })
                });

                const result = await response.json();
                if (result.success) {
                    currentUser.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${type}: ${result.message}`, 'error');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${type}: ${error.message}`, 'error');
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
        async function deleteProcessedSignals() {
            try {
                const url = `${SIGNALING_SERVER}?action=delete&userId=${currentUser.id}`;
                await fetch(url);
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
        }
        
        // –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function disconnectCall() {
            currentUser.log('üîå –†–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
            
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º disconnect —Å–∏–≥–Ω–∞–ª
            if (currentUser.targetUser) {
                await sendSignal('disconnect', { reason: 'user_disconnected' });
            }
            
            resetUser();
        }
        
        // –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function resetUser() {
            if (currentUser.interval) {
                clearInterval(currentUser.interval);
                currentUser.interval = null;
            }
            
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
            }
            
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            currentUser.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω', 'warning');
            updateUI();
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
        function copyLogs() {
            const log = document.getElementById('log').innerText;
            const allLogs = `=== –õ–û–ì–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===\n${log}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${SIGNALING_SERVER}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.id || '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}`;
            
            navigator.clipboard.writeText(allLogs).then(() => {
                alert('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
    </script>
</body>
</html>