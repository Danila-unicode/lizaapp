<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ - LizaApp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 8px; background: #fafafa; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ LizaApp</h1>
        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ª–æ–≥–∏–Ω–æ–º –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
        <button onclick="window.open('https://lizaapp.wg01.ru/register.php', '_blank')" style="background: #4CAF50; color: white; padding: 10px 20px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        
        <div class="user-section">
            <h2>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="loginSection">
                <input type="text" id="userId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
                <input type="password" id="userPassword" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display: none;">
                <button onclick="showPasswordField()">–í–æ–π—Ç–∏</button>
        </div>
            
            <div id="userInfo" style="display: none;">
                <div id="userStatus" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω</div>
                <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="currentUserId"></span></p>
                <input type="text" id="targetUserId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                <button onclick="startCall()" id="startCallBtn" disabled style="background: #4CAF50; color: white; display: none;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <button onclick="disconnectCall()" id="disconnectBtn" disabled style="background: #f44336; color: white; display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                <button onclick="resetUser()" style="background: #ff9800; color: white; display: none;">üîÑ –í—ã–π—Ç–∏</button>
        </div>
        
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000; border-radius: 5px;"></video>
                <video id="remoteVideo" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000; border-radius: 5px;"></video>
            </div>
            
            <div id="log" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>üìã –õ–æ–≥–∏</h2>
            <button onclick="copyLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        console.log('Script started');
        const WEBSOCKET_URL = 'wss://lizamsg.ru:9000';
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:89.169.141.202:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                { 
                    urls: 'turns:62.84.126.200:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = {
            id: null,
            ws: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            sessionToken: null,
            isInitiator: false,
            webrtcInitiated: false,
            wsConnected: false,
            wsUserId: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        function connectWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    const wsUrl = `${WEBSOCKET_URL}?username=${encodeURIComponent(currentUser.id)}`;
                    currentUser.ws = new WebSocket(wsUrl);
                    
                    currentUser.ws.onopen = () => {
                        currentUser.wsConnected = true;
                        currentUser.log('üîå WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                        resolve();
                    };
                    
                    currentUser.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            handleWebSocketMessage(message);
            } catch (error) {
                            currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`, 'error');
                        }
                    };
                    
                    currentUser.ws.onclose = () => {
                        currentUser.wsConnected = false;
                        currentUser.log('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        if (currentUser.id) {
                            setTimeout(() => {
                                if (currentUser.id && !currentUser.wsConnected) {
                                    currentUser.log('üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
                                    connectWebSocket().catch(error => {
                                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                                    });
                                }
                            }, 3000);
                        }
                    };
                    
                    currentUser.ws.onerror = (error) => {
                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ WebSocket: ${error.message}`, 'error');
                        reject(error);
                    };
                    
            } catch (error) {
                    reject(error);
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(message) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.type === 'connected') {
                currentUser.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ`, 'success');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º userId –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
                if (message.userId) {
                    currentUser.wsUserId = message.userId;
                    currentUser.log(`üÜî WebSocket ID: ${message.userId}`, 'info');
                }
                return;
            }
            
            if (message.type === 'error') {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${message.message}`, 'error');
                return;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
            if (message.from) {
                currentUser.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ: ${message.type} –æ—Ç ${message.from}`, 'info');
            }
            
            switch (message.type) {
                case 'ping':
                    handlePing(message);
                    break;
                case 'pong':
                    handlePong(message);
                    break;
                case 'offer':
                    handleOffer(message);
                    break;
                case 'answer':
                    handleAnswer(message);
                    break;
                case 'ice-candidate':
                    handleIceCandidate(message);
                    break;
                case 'disconnect':
                    handleDisconnect(message);
                    break;
                default:
                    if (message.from) {
                        currentUser.log(`‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: ${message.type}`, 'warning');
                    }
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
        function sendWebSocketMessage(type, data, to = null) {
            if (!currentUser.wsConnected || !currentUser.ws) {
                currentUser.log('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            const message = {
                type: type,
                from: currentUser.wsUserId || currentUser.id,
                to: to || currentUser.targetUser,
                data: data,
                timestamp: Date.now()
            };
            
            try {
                currentUser.ws.send(JSON.stringify(message));
                currentUser.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
                } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${type}: ${error.message}`, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
        function showPasswordField() {
            const passwordField = document.getElementById('userPassword');
            const loginButton = event.target;
            
            if (passwordField.style.display === 'none') {
                passwordField.style.display = 'block';
                loginButton.textContent = '–í–æ–π—Ç–∏';
                loginButton.onclick = () => startUser();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function startUser() {
            const username = document.getElementById('userId').value;
            const password = document.getElementById('userPassword').value;
            
            if (!username) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω`, 'error');
                return;
            }
            
            if (!password) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å`, 'error');
                return;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUser.log(`üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}...`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser.id = username;
                    currentUser.sessionToken = data.sessionToken;
                    currentUser.log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}`, 'error');
                    return;
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º`, 'error');
                return;
            }
            
            currentUser.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            currentUser.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.id} –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º`, 'success');
            currentUser.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${currentUser.lastSignalId}`, 'info');
            currentUser.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'info');
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
            try {
                await connectWebSocket();
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket: ${error.message}`, 'error');
                        return;
                    }
                    
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log('‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // WebSocket —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, polling –Ω–µ –Ω—É–∂–µ–Ω
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI();
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
            }
        }
        
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        function updateUI() {
            const loginSection = document.getElementById('loginSection');
            const userInfo = document.getElementById('userInfo');
            const userStatus = document.getElementById('userStatus');
            const currentUserId = document.getElementById('currentUserId');
            const startCallBtn = document.getElementById('startCallBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const resetBtn = document.querySelector('button[onclick="resetUser()"]');
            
            if (currentUser.id) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'none';
                userInfo.style.display = 'block';
                currentUserId.textContent = currentUser.id;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                userStatus.textContent = getStatusText();
                userStatus.className = `status ${currentUser.state}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                if (currentUser.state === 'idle') {
                startCallBtn.style.display = 'inline-block';
                startCallBtn.disabled = false;
                disconnectBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                } else if (currentUser.state === 'connecting' || currentUser.state === 'connected' || currentUser.state === 'calling') {
                    startCallBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                    resetBtn.style.display = 'inline-block';
                }
                } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        function getStatusText() {
            switch (currentUser.state) {
                case 'idle': return '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º';
                case 'connecting': return '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                case 'connected': return '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                case 'calling': return '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                default: return '–û—Ç–∫–ª—é—á–µ–Ω';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞
        async function startCall() {
            const targetId = document.getElementById('targetUserId').value;
            
            if (!targetId) {
                currentUser.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'error');
                return;
            }

            currentUser.log(`üìû –ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫ –∫ ${targetId}`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = targetId;
            currentUser.isInitiator = true;
            currentUser.webrtcInitiated = false;
            updateUI();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping —á–µ—Ä–µ–∑ WebSocket
            currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
            sendWebSocketMessage('ping', { timestamp: Date.now() }, targetId);
        }
        
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ping
        function handlePing(signal) {
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }

            currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = signal.from;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            updateUI();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º pong —á–µ—Ä–µ–∑ WebSocket
            sendWebSocketMessage('pong', { received: true }, signal.from);
            currentUser.state = 'connected';
            updateUI();
            
            // –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π –∑–≤–æ–Ω–æ–∫ –ù–ï –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç WebRTC - –∂–¥–µ—Ç offer –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
            currentUser.log(`‚è≥ –ñ–¥–µ–º offer –æ—Ç ${signal.from}...`, 'info');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ pong
        function handlePong(signal) {
            if (currentUser.state === 'connecting' && currentUser.targetUser === signal.from) {
                currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                currentUser.state = 'connected';
                updateUI();
                
                // –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–≤–æ–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç offer –ø–æ—Å–ª–µ pong
                if (currentUser.isInitiator) {
                    initiateWebRTC();
                }
            } else {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞—Ü–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function initiateWebRTC() {
            if (currentUser.state !== 'connected' || currentUser.webrtcInitiated) {
                return;
            }
            
            currentUser.webrtcInitiated = true;
            currentUser.log(`üé• –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`, 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => {
                        currentUser.peerConnection.addTrack(track, currentUser.localStream);
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                const offer = await currentUser.peerConnection.createOffer();
                await currentUser.peerConnection.setLocalDescription(offer);
                
                await sendSignal('offer', offer);
                currentUser.log('‚úÖ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ WebRTC: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ offer
        async function handleOffer(signal) {
            if (currentUser.state !== 'connected') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }

            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => {
                        currentUser.peerConnection.addTrack(track, currentUser.localStream);
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await currentUser.peerConnection.setRemoteDescription(signal.data);
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                const answer = await currentUser.peerConnection.createAnswer();
                await currentUser.peerConnection.setLocalDescription(answer);
                
                await sendSignal('answer', answer);
                currentUser.log('‚úÖ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(signal) {
            if (currentUser.state !== 'connected') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'info');
            
            try {
                if (currentUser.peerConnection) {
                    await currentUser.peerConnection.setRemoteDescription(signal.data);
                    currentUser.log('‚úÖ Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                    currentUser.state = 'calling';
                    updateUI();
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        async function handleIceCandidate(signal) {
            if (currentUser.peerConnection) {
                try {
                    await currentUser.peerConnection.addIceCandidate(signal.data);
                    currentUser.log(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${signal.from}`, 'info');
            } catch (error) {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ disconnect
        async function handleDisconnect(signal) {
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω disconnect –æ—Ç ${signal.from}`, 'warning');
            
            if (currentUser.targetUser === signal.from) {
                currentUser.log(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ`, 'warning');
                await resetUser();
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ WebSocket
        function sendSignal(type, data) {
            sendWebSocketMessage(type, data);
        }
        
        
        // –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function disconnectCall() {
            currentUser.log('üîå –†–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
            
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º disconnect —Å–∏–≥–Ω–∞–ª
            if (currentUser.targetUser) {
                await sendSignal('disconnect', { reason: 'user_disconnected' });
            }
            
            await resetUser();
        }
        
        // –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function resetUser() {
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (currentUser.ws) {
                currentUser.ws.close();
                currentUser.ws = null;
                currentUser.wsConnected = false;
                currentUser.wsUserId = null;
            }
            
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            currentUser.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω', 'warning');
            updateUI();
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
        function copyLogs() {
            const log = document.getElementById('log').innerText;
            const allLogs = `=== –õ–û–ì–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===\n${log}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${WEBSOCKET_URL}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.id || '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}`;
            
            navigator.clipboard.writeText(allLogs).then(() => {
                alert('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
    </script>
</body>
</html>
